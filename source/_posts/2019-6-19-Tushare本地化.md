---
title: Tushareæœ¬åœ°åŒ–
categories:
  - ç¨‹åº
tags:
  - è‚¡ç¥¨
  - Tushare
  - æœ¬åœ°åŒ–
  - QUANTAXIS
date: 2019-6-19
abbrlink: 4210503008
---
# äº‹ç”±

æ•°æ®æœ¬åœ°åŒ–æ˜¯ä¸æƒ³ä¾é å¹³å°ï¼Œä¸‡ä¸€å“ªå¤©æŒ‚äº†æ²¡åœ°æ–¹å“­ã€‚

ä¹‹å‰æœ¬åœ°åŒ–æ˜¯åŸºäºié—®è´¢ï¼Œè™½ç„¶è·å–çš„æ˜¯è‡ªå·±æœ€éœ€è¦çš„ä¸€äº›æ•°æ®ï¼Œä½†æ˜¯æƒ³è¿›è¡Œä¸€äº›åˆ«çš„åˆ†æçš„æ—¶å€™ï¼Œæ•°æ®å¹¶ä¸è¶³å¤Ÿã€‚

é‡æ–°å†å»ä¸‹è½½ä¹Ÿä¸æ˜¯ä¸å¯ä»¥ï¼Œä½†æ˜¯é‚£ä¸ªå·¥ä½œé‡å°±ä¸æ˜¯ä»¥å°æ—¶è®¡ç®—ï¼Œè€Œæ˜¯ä»¥å¤©ã€‚

å› æ­¤ï¼Œæƒ³å°†å®Œæ•´çš„äº¤æ˜“æ•°æ®ï¼Œè´¢åŠ¡æ•°æ®æœ¬åœ°åŒ–ã€‚

å…¶å®ï¼Œä¸æ˜¯æ²¡æœ‰ç°æˆçš„å¯ä»¥ç”¨ã€‚

QUANTAXIS æ˜¯ä¸€ä¸ªä¸é”™çš„è§£å†³æ¡†æ¶ï¼Œå†™è¿™ä¸ª Tushare æœ¬åœ°åŒ–ä¹Ÿæ˜¯å‚ç…§äº†å…¶ä¸­ä¸€äº›æ€è·¯ã€‚

ä½†æ˜¯åŸºäºä¸‰ç‚¹ç†ç”±ï¼Œæ²¡æœ‰ç›´æ¥ä½¿ç”¨ QUANTAXIS è€Œæ˜¯è‡ªå·±å¦å¤–å†™ä¸€ä¸ª

1. QUANTAXIS æ˜¯ä¸€ä¸ªé€šç”¨æ¡†æ¶ï¼Œå¯¹æˆ‘ä½¿ç”¨æ¥è¯´å¤æ‚äº†ï¼Œå¾ˆå¤šæ¨¡å—ç”¨ä¸ä¸Š

2. QUANTAXIS æ•°æ®æºæœ‰å¤šç§è·å–æ–¹å¼ï¼Œä½†åŸºæœ¬ä¸Šæ˜¯åŸºäº tdxï¼Œtdx æœ‰ç‚¹ä¸å¥½çš„å°±æ˜¯è´¢åŠ¡æ•°æ®æ›´æ–°æ¯”è¾ƒæ…¢ã€‚QUANTAXIS Tushare ä¹Ÿæœ‰å®ç°æ–¹å¼ï¼Œä½†æ˜¯åªæ˜¯éƒ¨åˆ†ã€‚

3. QUANTAXIS æ˜¯ç”¨ mongodb åºåˆ—åŒ–ï¼Œè€Œæˆ‘éœ€è¦çš„æ˜¯ä¸€ä¸ªåŸºäºæ•°æ®æ–‡ä»¶çš„åºåˆ—åŒ–ã€‚

# è®¾è®¡

```mermaid  
graph TD;
    save_tushare --> SATushare;
    SATushare --> T[tushare pro];
    save_tushare --> SAStorage;
    SAStorage --> SAStorage_hdf;
    SAFetch --> SAStorage;
```

- SATushareï¼šé€šè¿‡ tushare pro æ¥å£è·å–æ•°æ®ï¼Œå°è£…åŸºç¡€éªŒè¯ã€æ—¥æœŸã€ä»£ç ç­‰åˆæ­¥å¤„ç†

- save_tushareï¼šè°ƒç”¨ SATushare è·å–æ•°æ®ï¼Œé€šè¿‡ SAStorage åºåˆ—åŒ–åˆ°æœ¬åœ°

- SAStorage_hdfï¼šåºåˆ—åŒ–å®ç°æ–¹å¼

- SAFetchï¼šä»æœ¬åœ°æ•°æ®æ–‡ä»¶æå–æ•°æ®

é‡‡ç”¨æ—¥å¢é‡æ•°æ®æ–¹å¼ä¿å­˜ï¼Œå¦‚æœè¦ç”¨å…¶ä»–åºåˆ—åŒ–æ–¹å¼ä¹Ÿå¾ˆæ–¹ä¾¿ï¼Œå¢åŠ å¯¹åº”çš„ SAStorage_XXXX

SAFetch å¼•ç”¨å¯¹åº”çš„ SAStorage_XXX å°±å¯ä»¥äº†

åŒæ ·çš„ï¼Œè¦æœ¬åœ°åŒ–å…¶ä»–æ•°æ®æºï¼Œå¢åŠ  SAXXXX å’Œ save_XXXX å³å¯

# å®ç°ï¼ˆéƒ¨åˆ†ï¼Œæˆ‘ä¹Ÿæ²¡å®Œå…¨åšå®ŒğŸ˜­ï¼‰

## 1. SAStorage_hdf

ä¸»è¦å®ç°æ•°æ®è¡¨çš„ä¿å­˜ã€è¯»å–ç­‰å¸¸è§„æ“ä½œ

#### ä¿å­˜
```
def _save(data, table, append=False, **kwargs):
    """
    ä¿æŒæ•°æ®åˆ°æ–‡ä»¶
    
    Arguments:
        data    æ•°æ®ï¼ŒDataframe
        table 	è¡¨å
    """
    dp = "{}{}{}.hdf".format(data_path, os.sep, table)
    try:
        data.to_hdf(dp,
                    key=table,
                    format="table",
                    mode="a",
                    append=append,
                    data_columns=True,
                    **kwargs)
    except Exception as e:
        log_info(e)
```
#### è¯»å–
```
def _load(table, **kwargs):
    """
    è¯»å–æ•°æ®æ–‡ä»¶ï¼Œè¿”å›df
    
    Arguments:
        table   è¡¨å
    Returns:
        dataframe
    """
    dp = "{}{}{}.hdf".format(data_path, os.sep, table)
    try:
        return pd.read_hdf(dp, key=table, mode="a", **kwargs)
    except Exception as e:
        log_info(e)
        return pd.DataFrame()
```
## 2. SATushare
ä¸€ä¸€å¯¹åº” tushare pro çš„[æ•°æ®æ¥å£](https://tushare.pro/document/2)ï¼Œå¹¶å¯¹è·å–ç»“æœè¿›è¡Œä¸€äº›æ“ä½œï¼Œæ¯”å¦‚è‚¡ç¥¨ä»£ç ï¼Œæ—¥æœŸç»Ÿä¸€å¤„ç†

#### tushare pro æ¥å£åˆå§‹åŒ–
```
def set_token(token=None):
    try:
        if token is None:
            token = SASETTING.get_config("tushare", "token", None)
        else:
            SASETTING.set_config("tushare", "token", token)
        ts.set_token(token)
    except Exception as e:
        if token is None:
            print("è¯·è®¾ç½®tushareçš„token")
        else:
            print("è¯·å‡çº§tushare è‡³æœ€æ–°ç‰ˆæœ¬ pip install tushare -U")
        print(e)


def get_pro():
    try:
        set_token()
        pro = ts.pro_api()
    except Exception as e:
        if isinstance(e, NameError):
            print("è¯·è®¾ç½®tushare proçš„tokenå‡­è¯ç ")
        else:
            print("è¯·å‡çº§tushare è‡³æœ€æ–°ç‰ˆæœ¬ pip install tushare -U")
            print(e)
        pro = None
    return pro
```
#### è·å–äº¤æ˜“æ—¥å†
```
def get_trade_cal(exchange="SSE",
                  start_date="19901219",
                  end_date="20190101",
                  is_open=""):
    """
    è·å–å„å¤§äº¤æ˜“æ‰€äº¤æ˜“æ—¥å†æ•°æ®,é»˜è®¤æå–çš„æ˜¯ä¸Šäº¤æ‰€

    Arguments:
        exchange 	str 	N 	äº¤æ˜“æ‰€ SSEä¸Šäº¤æ‰€ SZSEæ·±äº¤æ‰€
        start_date 	str 	N 	å¼€å§‹æ—¥æœŸ
        end_date 	str 	N 	ç»“æŸæ—¥æœŸ
        is_open 	str 	N 	æ˜¯å¦äº¤æ˜“ '0'ä¼‘å¸‚ '1'äº¤æ˜“

    Returns:
        exchange 	str 	Y 	äº¤æ˜“æ‰€ SSEä¸Šäº¤æ‰€ SZSEæ·±äº¤æ‰€
        cal_date 	str 	Y 	æ—¥å†æ—¥æœŸ
        is_open 	str 	Y 	æ˜¯å¦äº¤æ˜“ 0ä¼‘å¸‚ 1äº¤æ˜“
        pretrade_date 	str 	N 	ä¸Šä¸€ä¸ªäº¤æ˜“æ—¥
    """

    def _get_trade_cal():
        log_info("æ­£åœ¨ä¸‹è½½äº¤æ˜“æ—¥å†...")
        try:
            pro = get_pro()
            data = pro.trade_cal(
                start_date=start_date,
                end_date=end_date,
                exchange=exchange,
                is_open=is_open,
                fields="exchange, cal_date, is_open, pretrade_date")
            log_info("ä¸‹è½½äº¤æ˜“æ—¥å† TRADE_DATE {}-{} æˆåŠŸ".format(start_date, end_date))
        except Exception as e:
            print(e)
            log_info(e)
            time.sleep(1)
            data = _get_trade_cal()
        return data

    return _get_trade_cal()
  ```

#### è·å–æ¯æ—¥æŒ‡æ ‡
```
def get_daily_basic(ts_code="", trade_date="", start_date="", end_date=""):
    """
    æ›´æ–°æ—¶é—´ï¼šäº¤æ˜“æ—¥æ¯æ—¥15ç‚¹ï½17ç‚¹ä¹‹é—´
    æè¿°ï¼šè·å–å…¨éƒ¨è‚¡ç¥¨æ¯æ—¥é‡è¦çš„åŸºæœ¬é¢æŒ‡æ ‡ï¼Œå¯ç”¨äºé€‰è‚¡åˆ†æã€æŠ¥è¡¨å±•ç¤ºç­‰ã€‚

    Arguments:
        ts_code 	str 	N 	è‚¡ç¥¨ä»£ç ï¼ˆäºŒé€‰ä¸€ï¼‰
        trade_date 	str 	N 	äº¤æ˜“æ—¥æœŸï¼ˆäºŒé€‰ä¸€ï¼‰
        start_date 	str 	N 	å¼€å§‹æ—¥æœŸ(YYYYMMDD)
        end_date 	str 	N 	ç»“æŸæ—¥æœŸ(YYYYMMDD)

    Returns:
        ts_code 	str 	TSè‚¡ç¥¨ä»£ç 
        trade_date 	str 	äº¤æ˜“æ—¥æœŸ
        close 	float 	å½“æ—¥æ”¶ç›˜ä»·
        turnover_rate 	float 	æ¢æ‰‹ç‡ï¼ˆ%ï¼‰
        turnover_rate_f 	float 	æ¢æ‰‹ç‡ï¼ˆè‡ªç”±æµé€šè‚¡ï¼‰
        volume_ratio 	float 	é‡æ¯”
        pe 	float 	å¸‚ç›ˆç‡ï¼ˆæ€»å¸‚å€¼/å‡€åˆ©æ¶¦ï¼‰
        pe_ttm 	float 	å¸‚ç›ˆç‡ï¼ˆTTMï¼‰
        pb 	float 	å¸‚å‡€ç‡ï¼ˆæ€»å¸‚å€¼/å‡€èµ„äº§ï¼‰
        ps 	float 	å¸‚é”€ç‡
        ps_ttm 	float 	å¸‚é”€ç‡ï¼ˆTTMï¼‰
        total_share 	float 	æ€»è‚¡æœ¬ ï¼ˆä¸‡è‚¡ï¼‰
        float_share 	float 	æµé€šè‚¡æœ¬ ï¼ˆä¸‡è‚¡ï¼‰
        free_share 	float 	è‡ªç”±æµé€šè‚¡æœ¬ ï¼ˆä¸‡ï¼‰
        total_mv 	float 	æ€»å¸‚å€¼ ï¼ˆä¸‡å…ƒï¼‰
        circ_mv 	float 	æµé€šå¸‚å€¼ï¼ˆä¸‡å…ƒï¼‰
    """

    def _get_daily_basic():
        log_info("æ­£åœ¨ä¸‹è½½æ¯æ—¥æŒ‡æ ‡æ•°æ®...")
        try:
            pro = get_pro()
            data = pro.daily_basic(
                ts_code=ts_code,
                trade_date=trade_date,
                start_date=start_date,
                end_date=end_date,
                fields=
                " ts_code, trade_date, close, turnover_rate, turnover_rate_f, volume_ratio, pe, pe_ttm, pb, ps, ps_ttm, total_share, float_share, free_share, total_mv, circ_mv"
            )
            log_info("ä¸‹è½½æ¯æ—¥æŒ‡æ ‡æ•°æ® DAILY_BASIC #{} æˆåŠŸ".format(trade_date))
        except Exception as e:
            print(e)
            log_info(e)
            time.sleep(1)
            data = _get_daily_basic()
        return data

    return _get_daily_basic()
```
å…¶ä»–å¦‚æ­¤ç±»æ¨

## 3. SAFetch
è¯»å–æœ¬åœ°æ•°æ®ï¼Œå¾ˆç®€å•ï¼Œä¸€ä¸ªè¡¨ä¸€ä¸ª

```
def SA_get_stock_basic(**kwargs):
    return _load("STOCK_BASIC", **kwargs)


def SA_get_trade_cal(**kwargs):
    return _load("TRADE_CAL", **kwargs)


def SA_get_stock_daily(**kwargs):
    return _load("STOCK_DAILY",**kwargs)


def SA_get_daily_basic(**kwargs):
    return _load("DAILY_BASIC", **kwargs)


def SA_get_index_daily(**kwargs):
    return _load("INDEX_DAILY", **kwargs)

def SA_get_index_basic(**kwargs):
    return _load("INDEX_BASIC", **kwargs)

def SA_get_trade_date(start_date, end_date):
    df = SA_get_trade_cal()

    if len(df) > 0:
        return df["cal_date"][(df["cal_date"] >= start_date)
                              & (df["cal_date"] <= end_date) &
                              (df["is_open"] == 1)]
```

## 4. save_tushare
æ‰§è¡Œæœ¬åœ°åŒ–

#### å°†äº¤æ˜“æ—¥å†å­˜åˆ°æœ¬åœ°æ–‡ä»¶è¡¨ TRADE_CAL
```
def save_trade_cal():
    df = SA_get_trade_cal()

    # è¿™ä¸ªæ•°æ®å¹¶ä¸æ˜¯å¾ˆå¤§ï¼Œæ‰€ä»¥ä¸é‡‡ç”¨å¢é‡æ–¹å¼ä¿å­˜ï¼Œç›´æ¥è¦†ç›–
    # è·å–æœ€åä¸€ä¸ªæ—¶é—´
    # if len(df) > 0:
    #     start_date = df["cal_date"].iloc[-1].replace('-', '')
    # else:
    #     start_date = "19901219"

    # 2000-01-01 => 20000101
    end_date = today_str().replace('-', '')

    df = get_trade_cal(end_date=end_date)
    _save(df, table="TRADE_CAL")
```

#### æ—¥çº¿è¡Œæƒ…å’Œæ¯æ—¥æŒ‡æ ‡
```
def save_stock_daily():
    df_stock_daily = SA_get_stock_daily()
    # è·å–æœ€åä¸€ä¸ªè®°å½•æ—¶é—´
    if len(df_stock_daily) > 0:
        start_date = df_stock_daily["trade_date"].iloc[-1].replace('-', '')
    else:
        start_date = "19901219"

    end_date = today_str().replace('-', '')

    trade_date = SA_get_trade_date(start_date, end_date)
    log_info("å‡†å¤‡ä¸‹è½½{}-{}æ—¥çº¿è¡Œæƒ…æ•°æ®...".format(start_date, end_date))
    for date in trade_date:
        df = get_stock_daily(trade_date=date)
        _save(df, table="STOCK_DAILY", append=True)
    log_info("ä¸‹è½½{}-{}æ—¥çº¿è¡Œæƒ…æ•°æ®å®Œæˆ".format(start_date, end_date))


def save_daily_basic():
    df_daily_basic = SA_get_daily_basic()
    # è·å–æœ€åä¸€ä¸ªè®°å½•æ—¶é—´
    if len(df_daily_basic) > 0:
        start_date = df_daily_basic["trade_date"].iloc[-1].replace('-', '')
    else:
        start_date = "19901219"

    end_date = today_str().replace('-', '')

    trade_date = SA_get_trade_date(start_date, end_date)
    log_info("å‡†å¤‡ä¸‹è½½{}-{}æ¯æ—¥æŒ‡æ ‡æ•°æ®...".format(start_date, end_date))
    for date in trade_date:
        df = get_daily_basic(trade_date=date)
        df = df.fillna(0.00)
        _save(df, table="DAILY_BASIC", append=True)
    log_info("ä¸‹è½½{}-{}æ¯æ—¥æŒ‡æ ‡æ•°æ®å®Œæˆ".format(start_date, end_date))
```
## 5. æœ¬åœ°åŒ–ç»“æœ

![20190619-3](/images/20190619-0.png)

ç°åœ¨åªæ˜¯å®ç°äº†å…¶ä¸­6ä¸ªæ¥å£ï¼Œå†å²æ—¥çº¿æ•°æ®å¤§æ¦‚æ˜¯ 1G

è´¢åŠ¡æ•°æ®æ¥å£è¿˜æ²¡å†™å¥½

# TODO

- Tushare Pro çš„å…¶ä»–æ¥å£å®ç°

- è·å–æ•°æ®åçš„ç»Ÿä¸€å¤„ç†è¿˜æ²¡å†™çš„

- ç”±äºæ•°æ®è·Ÿä¹‹å‰ä¸ä¸€æ ·äº†ï¼Œå‰ç«¯è¦æ”¹

- è¿˜æ²¡æƒ³åˆ°ã€‚ã€‚ã€‚ã€‚